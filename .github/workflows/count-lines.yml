name: Count Lines of Code

on:
  schedule:
    - cron: '0 0 * * 0' # Run every Sunday at midnight
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  count-lines:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        
      - name: Install cloc
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc
          
      - name: Get all repos
        id: repos
        run: |
          # Check if PAT_TOKEN is available for private repos
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "‚úÖ Using PAT_TOKEN to access all repositories (public + private)"
            TOKEN="${{ secrets.PAT_TOKEN }}"
          else
            echo "‚ö†Ô∏è Using GITHUB_TOKEN (public repos only)"
            echo "To count private repos, add a PAT_TOKEN secret with 'repo' scope"
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
          fi
          
          # Get all repos from the organization (including private if PAT is used)
          curl -H "Authorization: token $TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/orgs/RoboNexxus/repos?per_page=100 > repos.json
          
          # Debug: Show API response
          echo "API Response (first 20 lines):"
          head -20 repos.json
          
          # Check if repos.json is an array before extracting names
          if jq -e 'type == "array"' repos.json > /dev/null 2>&1; then
            jq -r '.[].name' repos.json > repo_list.txt
            echo "Successfully extracted $(wc -l < repo_list.txt) repositories:"
            cat repo_list.txt
          else
            echo "ERROR: API did not return a repo array."
            cat repos.json
            exit 1
          fi
          
      - name: Clone and count lines
        env:
          TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          total_lines=0
          total_code=0
          total_comments=0
          total_blanks=0
          repo_count=0
          
          # Create temp directory
          mkdir -p temp_repos
          
          echo "================================"
          echo "Starting to count lines..."
          echo "================================"
          
          # Clone each repo and count lines
          while IFS= read -r repo; do
            echo ""
            echo "üì¶ Processing: $repo"
            git clone https://x-access-token:${TOKEN}@github.com/RoboNexxus/$repo.git temp_repos/$repo 2>/dev/null || {
              echo "  ‚ùå Failed to clone $repo"
              continue
            }
            
            # Count lines using cloc
            cloc temp_repos/$repo --json --quiet > cloc_output.json 2>/dev/null || {
              echo "  ‚ö†Ô∏è No code found in $repo"
              rm -rf temp_repos/$repo
              continue
            }
            
            # Extract totals
            code=$(cat cloc_output.json | jq -r '.SUM.code // 0')
            comments=$(cat cloc_output.json | jq -r '.SUM.comment // 0')
            blanks=$(cat cloc_output.json | jq -r '.SUM.blank // 0')
            
            if [ "$code" -gt 0 ]; then
              total_code=$((total_code + code))
              total_comments=$((total_comments + comments))
              total_blanks=$((total_blanks + blanks))
              repo_count=$((repo_count + 1))
              echo "  ‚úÖ $repo: $code lines of code"
            else
              echo "  ‚ö†Ô∏è $repo: No code detected"
            fi
            
            # Clean up
            rm -rf temp_repos/$repo
          done < repo_list.txt
          
          total_lines=$((total_code + total_comments + total_blanks))
          
          # Format numbers with commas
          formatted_lines=$(printf "%'d" $total_lines)
          formatted_code=$(printf "%'d" $total_code)
          
          echo ""
          echo "================================"
          echo "üìä FINAL RESULTS"
          echo "================================"
          echo "Total Lines: $formatted_lines"
          echo "Code Lines: $formatted_code"
          echo "Comments: $total_comments"
          echo "Blanks: $total_blanks"
          echo "Repositories: $repo_count"
          echo "================================"
          
          echo "TOTAL_LINES=$formatted_lines" >> $GITHUB_ENV
          echo "TOTAL_CODE=$formatted_code" >> $GITHUB_ENV
          echo "REPO_COUNT=$repo_count" >> $GITHUB_ENV
          
      - name: Update README
        run: |
          # Update the README with the new counts
          sed -i "s/Total_Lines-Calculating\.\.\./Total_Lines-${{ env.TOTAL_LINES }}/g" Profile/Readme.md
          sed -i "s/Calculating\.\.\.-00d9ff/Calculating...-00d9ff/g" Profile/Readme.md || true
          sed -i "s/Total_Lines-[0-9,]*-00d9ff/Total_Lines-${{ env.TOTAL_LINES }}-00d9ff/g" Profile/Readme.md || true
          sed -i "s/Total_Lines-[0-9,]*/Total_Lines-${{ env.TOTAL_LINES }}/g" Profile/Readme.md || true
          sed -i "s/Across all repositories/Across all ${{ env.REPO_COUNT }} repositories/g" Profile/Readme.md || true
          
      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions[bot]"
          git add Profile/Readme.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "üìä Update lines of code count: ${{ env.TOTAL_LINES }} lines across ${{ env.REPO_COUNT }} repos" && git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} HEAD:main)
